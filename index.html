<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëä±ÁÅ´Â∏´„ÅÆÊóÖ - 47ÈÉΩÈÅìÂ∫úÁúå</title>
    <!-- ÂèØÊÑõ„ÅÑ‰∏∏„Ç¥„Ç∑„ÉÉ„ÇØ„Éï„Ç©„É≥„Éà -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #a3d8f4 0%, #ffe6fa 100%);
            font-family: 'M PLUS Rounded 1c', 'Arial Rounded MT Bold', 'Arial', sans-serif;
            overflow: hidden; user-select: none;
        }
        #gameContainer { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #gameCanvas { position: absolute; top: 0; left: 0; background: transparent; }
        /* --- ÂèØÊÑõ„ÅÑUI --- */
        #ui {
            position: absolute; top: 20px; left: 20px;
            color: #a14f7a;
            z-index: 100; font-size: 18px;
            background: rgba(255,255,255,0.7);
            border-radius: 18px;
            box-shadow: 0 2px 8px #ffb6d540;
            padding: 10px 20px;
            display: flex; gap: 18px; align-items: center;
        }
        #ui .badge {
            background: linear-gradient(90deg, #ffe6fa 0%, #e0f7fa 100%);
            border-radius: 16px;
            padding: 4px 12px;
            font-weight: bold;
            color: #e75480;
            margin-right: 6px;
            box-shadow: 0 1px 4px #ffb6d540;
            display: inline-block;
        }
        #ui .heart {
            color: #ff6fa0; font-size: 1.1em; margin: 0 2px;
            text-shadow: 0 1px 6px #fff6;
        }
        #currentPrefecture {
            position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%);
            color: #ffff88; font-size: 48px; font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 200; opacity: 0; transition: opacity 0.5s; text-align: center;
        }
        #hanabiName {
            position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%);
            color: #ffb347; font-size: 28px; font-weight: bold;
            text-shadow: 2px 2px 6px #000;
            z-index: 210; opacity: 0; transition: opacity 0.5s; text-align: center;
        }
        #instructions {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            color: #a14f7a; text-align: center; z-index: 100;
            font-size: 18px;
            background: rgba(255,255,255,0.8);
            border-radius: 14px;
            padding: 8px 20px;
            box-shadow: 0 1px 4px #ffb6d540;
            display: block;
        }
        #instructions .hint {
            font-size: 14px; color: #b48bb0; margin-top: 8px;
        }
        .firework {
            position: absolute; pointer-events: none; z-index: 150;
            animation: firework-pop 0.8s linear;
        }
        @keyframes firework-pop {
            0% { opacity: 0.6; transform: scale(0.7);}
            60% { opacity: 1; transform: scale(1.2);}
            100% { opacity: 0; transform: scale(1);}
        }
        #jumpButton {
            position: fixed;
            bottom: 0; left: 0;
            width: 100vw; height: 70px;
            background: linear-gradient(90deg, #ffe6fa 0%, #e0f7fa 100%);
            color: #e75480;
            font-size: 28px; text-align: center; line-height: 70px;
            z-index: 300; user-select: none; border: none; outline: none;
            font-family: inherit; font-weight: bold;
            letter-spacing: 0.06em;
            box-shadow: 0 -1px 8px #ffb6d540;
            border-top: 2.5px solid #ffb6d5;
            transition: background 0.2s;
        }
        #jumpButton:active {
            background: linear-gradient(90deg, #ffb6d5 0%, #e0c3fc 100%);
            color: #fff;
        }
        #gameOver {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #e75480; font-size: 40px; font-weight: bold;
            text-shadow: 2px 2px 6px #fff;
            z-index: 500; display: none; text-align: center;
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            padding: 36px 36px 24px 36px;
            box-shadow: 0 2px 16px #ffb6d540;
        }
        #gameOver .fireworks {
            font-size: 2em; margin-bottom: 12px; display: block;
        }
        #prefectureInfo {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #a14f7a; font-size: 20px;
            background: rgba(255,255,255,0.92);
            border-radius: 14px; padding: 16px 24px;
            z-index: 220; opacity: 0; transition: opacity 0.5s;
            max-width: 90vw; text-align: center;
            box-shadow: 0 1px 8px #ffb6d540;
        }
        /* --- ÂèØÊÑõ„ÅÑ„É¢„Éº„ÉâÈÅ∏ÊäûÁîªÈù¢ --- */
        #modeSelect {
            background: linear-gradient(135deg, #ffe6fa 0%, #e0f7fa 100%);
            padding: 40px 50px 32px 50px;
            border-radius: 32px;
            box-shadow: 0 8px 40px 0 rgba(255,182,193,0.18), 0 2px 8px 0 rgba(174,213,255,0.12);
            top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 900; display: block; text-align: center;
            border: 3.5px solid #ffb6d5;
            color: #a14f7a;
            font-family: 'M PLUS Rounded 1c', 'Arial Rounded MT Bold', 'Arial', sans-serif;
            animation: popIn 0.7s cubic-bezier(.68,-0.55,.27,1.55);
            max-width: 95vw;
        }
        @keyframes popIn {
            0% { transform: scale(0.8) translate(-50%,-50%); opacity: 0; }
            100% { transform: scale(1) translate(-50%,-50%); opacity: 1; }
        }
        #modeSelect h2 {
            color: #e75480;
            font-weight: bold;
            font-size: 2.2em;
            margin-bottom: 18px;
            letter-spacing: 0.07em;
            text-shadow: 0 2px 10px #fff8, 0 1px 0 #fff;
            font-family: inherit;
        }
        #modeSelect .icon {
            font-size: 2.3em;
            margin-bottom: 2px;
            display: inline-block;
            vertical-align: middle;
            filter: drop-shadow(0 1px 4px #fff6);
        }
        #modeSelect button {
            display: block;
            margin: 18px auto;
            font-size: 22px;
            padding: 15px 44px;
            border-radius: 18px;
            border: none;
            background: linear-gradient(90deg, #ffb6d5 0%, #b9f8d3 100%);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 12px #ffb6d540, 0 1.5px 6px #b9f8d340;
            transition: background 0.2s, transform 0.12s, box-shadow 0.15s;
            font-family: inherit;
            letter-spacing: 0.07em;
            outline: none;
            border-bottom: 3px solid #e75480;
        }
        #modeSelect button:hover, #modeSelect button:focus {
            background: linear-gradient(90deg, #ffb6d5 10%, #e0c3fc 90%);
            color: #e75480;
            transform: scale(1.07);
            box-shadow: 0 6px 24px #ffb6d570, 0 2px 12px #e0c3fc55;
        }
        #modeSelect label {
            font-size: 18px;
            color: #d18ca5;
            display: block;
            margin-top: 22px;
            margin-bottom: 8px;
            font-weight: bold;
            letter-spacing: 0.04em;
            font-family: inherit;
        }
        #modeSelect select {
            font-size: 18px;
            margin: 0 8px;
            border-radius: 12px;
            border: 2.5px solid #ffb6d5;
            background: #fff8fc;
            color: #a14f7a;
            padding: 8px 10px;
            box-shadow: 0 1px 6px #ffb6d540;
            outline: none;
            font-family: inherit;
            width: 180px;
            transition: border 0.15s;
        }
        #modeSelect select:focus {
            border: 2.5px solid #e75480;
            background: #ffe6fa;
        }
        #modeSelect .hint {
            font-size: 14px;
            color: #b48bb0;
            margin-top: 8px;
            margin-bottom: 0;
            font-family: inherit;
        }
        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 600px) {
            #ui { font-size: 15px; padding: 6px 8px; gap: 10px;}
            #modeSelect { padding: 18px 2vw 12px 2vw; }
            #modeSelect h2 { font-size: 1.3em; }
            #modeSelect button { font-size: 1em; padding: 10px 10vw;}
            #instructions { font-size: 15px; padding: 6px 6vw;}
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui" style="display:none;">
            <span class="badge">ÈÉΩÈÅìÂ∫úÁúå: <span id="prefectureCount">1/47</span></span>
            <span class="badge">„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
            <span class="badge">„É©„Ç§„Éï: <span id="life"></span></span>
            <span class="badge">ÊôÇÈñì: <span id="timer">0:00</span></span>
            <span class="badge">ÈÄüÂ∫¶: <span id="speed">1.0x</span></span>
        </div>
        <div id="currentPrefecture"></div>
        <div id="hanabiName"></div>
        <div id="prefectureInfo"></div>
        <div id="instructions">
            <div>ÁîªÈù¢‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Ç∏„É£„É≥„ÉóÔºÅ</div>
            <div>„ÅîÂΩìÂú∞„Ç¢„Ç§„ÉÜ„É†„ÇíÈõÜ„ÇÅ„Å¶„Çπ„Ç≥„Ç¢UPÔºÅ</div>
            <div class="hint">„Ç∏„É£„É≥„Éó„Éú„Çø„É≥„ÇíÊäº„ÅóÁ∂ö„Åë„Çã„Å®ÊúÄÂ§ß3Áßí„Ç∏„É£„É≥„Éó„Åß„Åç„Åæ„Åô</div>
        </div>
        <button id="jumpButton" style="display:none;">„Ç∏„É£„É≥„ÉóÔºÅ</button>
        <div id="gameOver">
            <span class="fireworks">üéÜüéá</span>
            <div id="gameOverText"></div>
            <span id="finalScore"></span><br>
            <button id="retryBtn" style="margin-top:20px;font-size:20px;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂</button>
        </div>
        <!-- ÂèØÊÑõ„ÅÑ„É¢„Éº„ÉâÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="modeSelect">
            <span class="icon">üéÜ</span>
            <h2>„É¢„Éº„ÉâÈÅ∏Êäû</h2>
            <button id="fullModeBtn">üå∏ ÂÖ®ÂõΩÂà∂Ë¶áÔºà47ÈÉΩÈÅìÂ∫úÁúåÔºâ</button>
            <button id="shortModeBtn">üç° „Ç∑„Éß„Éº„ÉàÊóÖÔºà5Áúå„É©„É≥„ÉÄ„É†Ôºâ</button>
            <label>üéÄ „Çª„É¨„ÇØ„ÉàÊóÖÔºàÁúå„ÇíÈÅ∏„Å∂Ôºâ</label>
            <select id="selectPrefecture" multiple size="7"></select>
            <button id="selectModeBtn">„Åì„ÅÆÁúå„Åß„Çπ„Çø„Éº„Éà</button>
            <div class="hint">‚Äª Ctrl„Ç≠„Éº„ÇÑShift„Ç≠„Éº„ÅßË§áÊï∞ÈÅ∏Êäû„Åß„Åç„Åæ„Åô</div>
        </div>
    </div>
    <script>
    // --- ÂÖ®47ÈÉΩÈÅìÂ∫úÁúå„Éá„Éº„Çø ---
    const prefecturesData = [
        {name:'ÂåóÊµ∑ÈÅì',hanabi:'ÈÅìÊñ∞„ÉªUHBËä±ÁÅ´Â§ß‰ºö',bg:'#a3d8f4',info:'Êú≠Âπå„ÅÆÂ§ßÈÄöÂÖ¨Âúí„ÇÑÊó≠Â±±ÂãïÁâ©Âúí„ÅåÊúâÂêç„ÄÇ„É©„Éº„É°„É≥„ÇÑ„Ç∏„É≥„ÇÆ„Çπ„Ç´„É≥„ÅåÂêçÁâ©„ÄÇ',item:{name:'„Ç´„Éã',color:'#ff8888'},obstacle:{name:'Ê∞∑Â±±',color:'#b0e0ff'},bgType:'snow'},
        {name:'ÈùíÊ£ÆÁúå',hanabi:'ÈùíÊ£Æ„Å≠„Å∂„ÅüÁ•≠ÂçîË≥õËä±ÁÅ´Â§ß‰ºö',bg:'#c9e4c5',info:'„Å≠„Å∂„ÅüÁ•≠„ÇÑ„Çä„Çì„Åî„ÅåÊúâÂêç„ÄÇÊ¥•ËªΩÂºÅ„ÇÇÁâπÂæ¥ÁöÑ„ÄÇ',item:{name:'„Çä„Çì„Åî',color:'#ff4444'},obstacle:{name:'„Çä„Çì„ÅîÁÆ±',color:'#b22222'},bgType:'apple'},
        {name:'Â≤©ÊâãÁúå',hanabi:'Âåó‰∏ä„Åø„Å°„ÅÆ„ÅèËä∏ËÉΩ„Åæ„Å§„ÇäËä±ÁÅ´Â§ß‰ºö',bg:'#f3eac2',info:'„Çè„Çì„Åì„Åù„Å∞„ÇÑÂçóÈÉ®ÈâÑÂô®„ÅåÂêçÁâ©„ÄÇ‰∏ñÁïåÈÅ∫Áî£„ÉªÂπ≥Ê≥â„ÇÇ„ÄÇ',item:{name:'„Çè„Çì„Åì',color:'#aaaaff'},obstacle:{name:'Â≤©',color:'#888'},bgType:'mountain'},
        {name:'ÂÆÆÂüéÁúå',hanabi:'‰ªôÂè∞‰∏ÉÂ§ïËä±ÁÅ´Á•≠',bg:'#e7c8dd',info:'Áâõ„Çø„É≥„ÇÑ„Åö„Çì„Å†È§Ö„ÅåÊúâÂêç„ÄÇ‰ºäÈÅîÊîøÂÆó„ÅÆÂüé‰∏ãÁî∫„ÄÇ',item:{name:'Áâõ„Çø„É≥',color:'#cc9966'},obstacle:{name:'Áâõ',color:'#775533'},bgType:'city'},
        {name:'ÁßãÁî∞Áúå',hanabi:'Â§ßÊõ≤„ÅÆËä±ÁÅ´',bg:'#ffeebb',info:'„Åç„Çä„Åü„Çì„ÅΩ„ÇÑ„Å™„Åæ„ÅØ„Åí„ÅåÊúâÂêç„ÄÇÂ§ßÊõ≤„ÅØÊó•Êú¨ÊúâÊï∞„ÅÆËä±ÁÅ´Â§ß‰ºö„ÅÆÂú∞„ÄÇ',item:{name:'„Åç„Çä„Åü„Çì„ÅΩ',color:'#ffeebb'},obstacle:{name:'Êú®',color:'#8b5e3c'},bgType:'forest'},
        {name:'Â±±ÂΩ¢Áúå',hanabi:'Â±±ÂΩ¢Â§ßËä±ÁÅ´Â§ß‰ºö',bg:'#f7cac9',info:'„Åï„Åè„Çâ„Çì„Åº„ÇÑËäãÁÖÆ„ÅåÂêçÁâ©„ÄÇËîµÁéãÊ∏©Ê≥â„ÇÇ‰∫∫Ê∞ó„ÄÇ',item:{name:'„Åï„Åè„Çâ„Çì„Åº',color:'#ff3355'},obstacle:{name:'ËäãÁÖÆÈçã',color:'#8b5e3c'},bgType:'forest'},
        {name:'Á¶èÂ≥∂Áúå',hanabi:'È†àË≥ÄÂ∑ùÂ∏ÇÈáàËø¶Â†ÇÂ∑ùËä±ÁÅ´Â§ß‰ºö',bg:'#e3eaa7',info:'Ëµ§„Åπ„Åì„ÇÑÂñúÂ§öÊñπ„É©„Éº„É°„É≥„ÅåÊúâÂêç„ÄÇ‰ºöÊ¥•Ëã•ÊùæÂüé„ÇÇ„ÄÇ',item:{name:'Ëµ§„Åπ„Åì',color:'#d80000'},obstacle:{name:'Ëµ§„Åπ„Åì',color:'#d80000'},bgType:'mountain'},
        {name:'Ëå®ÂüéÁúå',hanabi:'ÂúüÊµ¶ÂÖ®ÂõΩËä±ÁÅ´Á´∂ÊäÄÂ§ß‰ºö',bg:'#e0eafc',info:'Á¥çË±Ü„ÇÑ„É°„É≠„É≥„ÅåÊúâÂêç„ÄÇÁ≠ëÊ≥¢Â±±„ÇÑÈúû„É∂Êµ¶„ÇÇ„ÄÇ',item:{name:'Á¥çË±Ü',color:'#c2b280'},obstacle:{name:'„É°„É≠„É≥',color:'#7ed957'},bgType:'mountain'},
        {name:'Ê†ÉÊú®Áúå',hanabi:'„ÅÜ„Å§„ÅÆ„Åø„ÇÑËä±ÁÅ´Â§ß‰ºö',bg:'#eaeaea',info:'„ÅÑ„Å°„Åî„ÇÑÈ§ÉÂ≠ê„ÅåÂêçÁâ©„ÄÇÊó•ÂÖâÊù±ÁÖßÂÆÆ„ÇÇ‰∏ñÁïåÈÅ∫Áî£„ÄÇ',item:{name:'„ÅÑ„Å°„Åî',color:'#ff5577'},obstacle:{name:'È§ÉÂ≠ê',color:'#ffe4b5'},bgType:'mountain'},
        {name:'Áæ§È¶¨Áúå',hanabi:'È´òÂ¥é„Åæ„Å§„ÇäÂ§ßËä±ÁÅ´Â§ß‰ºö',bg:'#f5e6e8',info:'ÁÑº„Åç„Åæ„Çì„Åò„ÇÖ„ÅÜ„ÇÑÊ∏©Ê≥â„ÅåÊúâÂêç„ÄÇËçâÊ¥•Ê∏©Ê≥â„ÇÇ„ÄÇ',item:{name:'ÁÑº„Åç„Åæ„Çì„Åò„ÇÖ„ÅÜ',color:'#ffbb77'},obstacle:{name:'Ê∏©Ê≥â„Åæ„Çì„Åò„ÇÖ„ÅÜ',color:'#eebb44'},bgType:'mountain'},
        {name:'ÂüºÁéâÁúå',hanabi:'Êà∏Áî∞Ê©ãËä±ÁÅ´Â§ß‰ºö',bg:'#e1f7d5',info:'ËçâÂä†„Åõ„Çì„Åπ„ÅÑ„ÇÑÁã≠Â±±Ëå∂„ÅåÊúâÂêç„ÄÇÂ∑ùË∂ä„ÅÆËîµÈÄ†„Çä„ÅÆÁî∫‰∏¶„Åø„ÇÇ‰∫∫Ê∞ó„ÄÇ',item:{name:'ËçâÂä†„Åõ„Çì„Åπ„ÅÑ',color:'#eebb44'},obstacle:{name:'„Åõ„Çì„Åπ„ÅÑÁº∂',color:'#eebb44'},bgType:'city'},
        {name:'ÂçÉËëâÁúå',hanabi:'ÂπïÂºµ„Éì„Éº„ÉÅËä±ÁÅ´„Éï„Çß„Çπ„Çø',bg:'#f0efeb',info:'ËêΩËä±Áîü„ÇÑÊàøÁ∑è„ÅÆÊµ∑Áî£Áâ©„ÅåÂêçÁâ©„ÄÇ„Éá„Ç£„Ç∫„Éã„Éº„É©„É≥„Éâ„ÇÇ„ÄÇ',item:{name:'ËêΩËä±Áîü',color:'#ffe4b5'},obstacle:{name:'„Éî„Éº„Éä„ÉÉ„ÉÑ',color:'#ffe4b5'},bgType:'sea'},
        {name:'Êù±‰∫¨ÈÉΩ',hanabi:'ÈöÖÁî∞Â∑ùËä±ÁÅ´Â§ß‰ºö',bg:'#e6e6fa',info:'Êó•Êú¨„ÅÆÈ¶ñÈÉΩ„ÄÇÊµÖËçâ„ÇÑÊù±‰∫¨„Çø„ÉØ„Éº„Å™„Å©Ë¶≥ÂÖâÂêçÊâÄ„ÅåÂ§ö„ÅÑ„ÄÇ',item:{name:'Èõ∑ÈñÄ',color:'#ff4444'},obstacle:{name:'Èõ∑ÈñÄ',color:'#ff4444'},bgType:'city'},
        {name:'Á•ûÂ•àÂ∑ùÁúå',hanabi:'Á•ûÂ•àÂ∑ùÊñ∞ËÅûËä±ÁÅ´Â§ß‰ºö',bg:'#c9daf8',info:'„Ç∑„Ç¶„Éû„Ç§„ÇÑ‰∏≠ËèØË°ó„ÅåÊúâÂêç„ÄÇÊ®™Êµú„Åø„Å™„Å®„Åø„Çâ„ÅÑ„ÇÇ‰∫∫Ê∞ó„ÄÇ',item:{name:'„Ç∑„Ç¶„Éû„Ç§',color:'#ccc'},obstacle:{name:'‰∏≠ËèØ„Åæ„Çì',color:'#fffde4'},bgType:'sea'},
        {name:'Êñ∞ÊΩüÁúå',hanabi:'Èï∑Â≤°„Åæ„Å§„ÇäÂ§ßËä±ÁÅ´Â§ß‰ºö',bg:'#fffde4',info:'Á±≥„Å©„Åì„Çç„ÄÇÁ¨πÂõ£Â≠ê„ÇÑÊó•Êú¨ÈÖí„ÇÇÊúâÂêç„ÄÇ',item:{name:'Á±≥',color:'#fffde4'},obstacle:{name:'Á¨πÂõ£Â≠ê',color:'#8bc34a'},bgType:'mountain'},
        {name:'ÂØåÂ±±Áúå',hanabi:'ÂåóÊó•Êú¨Êñ∞ËÅûÁ¥çÊ∂ºËä±ÁÅ´Â§ß‰ºö',bg:'#b2dfdb',info:'„Éõ„Çø„É´„Ç§„Ç´„ÇÑ„Åæ„ÅôÂØøÂè∏„ÅåÂêçÁâ©„ÄÇÁ´ãÂ±±ÈÄ£Â≥∞„ÇÇ„ÄÇ',item:{name:'„Éõ„Çø„É´„Ç§„Ç´',color:'#4444aa'},obstacle:{name:'„Åæ„ÅôÂØøÂè∏',color:'#ff8a65'},bgType:'mountain'},
        {name:'Áü≥Â∑ùÁúå',hanabi:'ÂåóÂúãËä±ÁÅ´ÈáëÊ≤¢Â§ß‰ºö',bg:'#ffd700',info:'ÈáëÁÆî„ÇÑÂä†Ë≥ÄÈáéËèú„ÅåÊúâÂêç„ÄÇÂÖºÂÖ≠Âúí„ÇÇË¶≥ÂÖâÂú∞„ÄÇ',item:{name:'ÈáëÁÆî',color:'#ffd700'},obstacle:{name:'Âä†Ë≥ÄÈáéËèú',color:'#7a3a9b'},bgType:'city'},
        {name:'Á¶è‰∫ïÁúå',hanabi:'Ë∂äÂâç„Åø„Å™„Å®Â§ßËä±ÁÅ´Â§ß‰ºö',bg:'#ff8888',info:'Ë∂äÂâç„Ç¨„Éã„ÇÑÊÅêÁ´úÂçöÁâ©È§®„ÅåÊúâÂêç„ÄÇ',item:{name:'Ë∂äÂâç„Ç¨„Éã',color:'#ff8888'},obstacle:{name:'ÊÅêÁ´ú',color:'#8bc34a'},bgType:'sea'},
        {name:'Â±±Ê¢®Áúå',hanabi:'Á•ûÊòé„ÅÆËä±ÁÅ´Â§ß‰ºö',bg:'#7a3a9b',info:'„Å∂„Å©„ÅÜ„ÇÑ„Åª„ÅÜ„Å®„ÅÜ„ÅåÂêçÁâ©„ÄÇÂØåÂ£´Â±±„ÇÇËøë„ÅÑ„ÄÇ',item:{name:'„Å∂„Å©„ÅÜ',color:'#7a3a9b'},obstacle:{name:'„Åª„ÅÜ„Å®„ÅÜÈçã',color:'#ffeebb'},bgType:'mountain'},
        {name:'Èï∑ÈáéÁúå',hanabi:'Ë´èË®™ÊπñÁ•≠Êπñ‰∏äËä±ÁÅ´Â§ß‰ºö',bg:'#ff4444',info:'„Çä„Çì„Åî„ÇÑ„Åù„Å∞„ÅåÂêçÁâ©„ÄÇÊùæÊú¨Âüé„ÇÑ‰∏äÈ´òÂú∞„ÇÇ„ÄÇ',item:{name:'„Çä„Çì„Åî',color:'#ff4444'},obstacle:{name:'„Åù„Å∞',color:'#bdb76b'},bgType:'mountain'},
        {name:'Â≤êÈòúÁúå',hanabi:'Èï∑ËâØÂ∑ùÂÖ®ÂõΩËä±ÁÅ´Â§ß‰ºö',bg:'#ff4444',info:'„Åï„Çã„Åº„Åº„ÇÑÈ£õÈ®®Áâõ„ÅåÂêçÁâ©„ÄÇÁôΩÂ∑ùÈÉ∑„ÇÇ‰∏ñÁïåÈÅ∫Áî£„ÄÇ',item:{name:'„Åï„Çã„Åº„Åº',color:'#ff4444'},obstacle:{name:'È£õÈ®®Áâõ',color:'#775533'},bgType:'mountain'},
        {name:'ÈùôÂ≤°Áúå',hanabi:'ÂÆâÂÄçÂ∑ùËä±ÁÅ´Â§ß‰ºö',bg:'#222',info:'„ÅÜ„Å™„Åé„ÇÑ„ÅäËå∂„ÄÅÂØåÂ£´Â±±„ÅåÊúâÂêç„ÄÇ',item:{name:'„ÅÜ„Å™„Åé',color:'#222'},obstacle:{name:'„ÅäËå∂Áº∂',color:'#228b22'},bgType:'sea'},
        {name:'ÊÑõÁü•Áúå',hanabi:'Â≤°Â¥éÂüé‰∏ãÂÆ∂Â∫∑ÂÖ¨Â§è„Åæ„Å§„ÇäËä±ÁÅ´Â§ß‰ºö',bg:'#b5651d',info:'„Å≤„Å§„Åæ„Å∂„Åó„ÇÑÂë≥Âôå„Ç´„ÉÑ„ÅåÂêçÁâ©„ÄÇÂêçÂè§Â±ãÂüé„ÇÇ„ÄÇ',item:{name:'„Å≤„Å§„Åæ„Å∂„Åó',color:'#b5651d'},obstacle:{name:'Âë≥Âôå„Ç´„ÉÑ',color:'#d2691e'},bgType:'city'},
        {name:'‰∏âÈáçÁúå',hanabi:'‰ºäÂã¢Á•ûÂÆÆÂ•âÁ¥çÂÖ®ÂõΩËä±ÁÅ´Â§ß‰ºö',bg:'#ff3333',info:'‰ºäÂã¢„Åà„Å≥„ÇÑËµ§Á¶è„ÅåÊúâÂêç„ÄÇ‰ºäÂã¢Á•ûÂÆÆ„ÇÇ„ÄÇ',item:{name:'‰ºäÂã¢„Åà„Å≥',color:'#ff3333'},obstacle:{name:'Ëµ§Á¶è',color:'#b5651d'},bgType:'sea'},
        {name:'ÊªãË≥ÄÁúå',hanabi:'„Å≥„ÇèÊπñÂ§ßËä±ÁÅ´Â§ß‰ºö',bg:'#ffeeaa',info:'ÈÆí„Åö„Åó„ÇÑËøëÊ±üÁâõ„ÅåÂêçÁâ©„ÄÇÁêµÁê∂Êπñ„ÅåÊó•Êú¨ÊúÄÂ§ß„ÅÆÊπñ„ÄÇ',item:{name:'ÈÆí„Åö„Åó',color:'#ffeeaa'},obstacle:{name:'ËøëÊ±üÁâõ',color:'#775533'},bgType:'sea'},
        {name:'‰∫¨ÈÉΩÂ∫ú',hanabi:'‰∫¨ÈÉΩËä∏Ë°ìËä±ÁÅ´',bg:'#bb6b14',info:'ÂÖ´„Å§Ê©ã„ÇÑÊäπËå∂„ÅåÂêçÁâ©„ÄÇÊ∏ÖÊ∞¥ÂØ∫„ÇÑÈáëÈñ£ÂØ∫„ÇÇÊúâÂêç„ÄÇ',item:{name:'ÂÖ´„Å§Ê©ã',color:'#bb6b14'},obstacle:{name:'ÊäπËå∂Âõ£Â≠ê',color:'#228b22'},bgType:'castle'},
        {name:'Â§ßÈò™Â∫ú',hanabi:'„Å™„Å´„ÇèÊ∑ÄÂ∑ùËä±ÁÅ´Â§ß‰ºö',bg:'#ff8844',info:'„Åü„ÅìÁÑº„Åç„ÇÑ„ÅäÂ•Ω„ÅøÁÑº„Åç„ÅåÂêçÁâ©„ÄÇÈÄöÂ§©Èñ£„ÇÑUSJ„ÇÇ„ÄÇ',item:{name:'„Åü„ÅìÁÑº„Åç',color:'#ff8844'},obstacle:{name:'„ÅäÂ•Ω„ÅøÁÑº„Åç',color:'#b5651d'},bgType:'city'},
        {name:'ÂÖµÂ∫´Áúå',hanabi:'„Åø„Å™„Å®Á•ûÊà∏Êµ∑‰∏äËä±ÁÅ´Â§ß‰ºö',bg:'#ffe4b5',info:'ÊòéÁü≥ÁÑº„Åç„ÇÑÁ•ûÊà∏Áâõ„ÅåÊúâÂêç„ÄÇÂß´Ë∑ØÂüé„ÇÇ‰∏ñÁïåÈÅ∫Áî£„ÄÇ',item:{name:'ÊòéÁü≥ÁÑº„Åç',color:'#ffe4b5'},obstacle:{name:'Á•ûÊà∏Áâõ',color:'#775533'},bgType:'sea'},
        {name:'Â•àËâØÁúå',hanabi:'„Å™„ÇâÁáàËä±‰ºöÂ§ßËä±ÁÅ´',bg:'#aaa',info:'Â§ß‰ªè„ÇÑÊüø„ÅÆËëâÂØøÂè∏„ÅåÂêçÁâ©„ÄÇÊù±Â§ßÂØ∫„ÇÑÈπø„ÇÇÊúâÂêç„ÄÇ',item:{name:'Â§ß‰ªè',color:'#aaa'},obstacle:{name:'Èπø',color:'#8b5e3c'},bgType:'mountain'},
        {name:'ÂíåÊ≠åÂ±±Áúå',hanabi:'Ê∏Ø„Åæ„Å§„ÇäËä±ÁÅ´Â§ß‰ºö',bg:'#d80000',info:'Ê¢ÖÂπ≤„Åó„ÇÑ„Åø„Åã„Çì„ÅåÂêçÁâ©„ÄÇÈ´òÈáéÂ±±„ÇÇ„ÄÇ',item:{name:'Ê¢ÖÂπ≤„Åó',color:'#d80000'},obstacle:{name:'„Åø„Åã„Çì',color:'#ffa500'},bgType:'sea'},
        {name:'È≥•ÂèñÁúå',hanabi:'„Åó„ÇÉ„Çì„Åó„ÇÉ„ÇìÁ•≠Ëä±ÁÅ´Â§ß‰ºö',bg:'#fffde4',info:'Ê¢®„ÇÑÁ†Ç‰∏ò„ÅåÊúâÂêç„ÄÇ',item:{name:'Ê¢®',color:'#fffde4'},obstacle:{name:'Á†Ç‰∏ò',color:'#ffe4b5'},bgType:'mountain'},
        {name:'Â≥∂Ê†πÁúå',hanabi:'ÊùæÊ±üÊ∞¥ÈÉ∑Á•≠Êπñ‰∏äËä±ÁÅ´Â§ß‰ºö',bg:'#333',info:'„Åó„Åò„Åø„ÇÑÂá∫Èõ≤„Åù„Å∞„ÅåÂêçÁâ©„ÄÇÂá∫Èõ≤Â§ßÁ§æ„ÇÇ„ÄÇ',item:{name:'„Åó„Åò„Åø',color:'#333'},obstacle:{name:'„Åù„Å∞',color:'#bdb76b'},bgType:'sea'},
        {name:'Â≤°Â±±Áúå',hanabi:'„Åä„Åã„ÇÑ„ÅæÊ°ÉÂ§™ÈÉé„Åæ„Å§„ÇäÁ¥çÊ∂ºËä±ÁÅ´Â§ß‰ºö',bg:'#ffb6b9',info:'„Åç„Å≥„Å†„Çì„Åî„ÇÑÊ°É„ÅåÂêçÁâ©„ÄÇÂæåÊ•ΩÂúí„ÇÇÊúâÂêç„ÄÇ',item:{name:'„Åç„Å≥„Å†„Çì„Åî',color:'#ffb6b9'},obstacle:{name:'Ê°É',color:'#ffb6b9'},bgType:'city'},
        {name:'Â∫ÉÂ≥∂Áúå',hanabi:'Â∫ÉÂ≥∂„Åø„Å™„Å®Â§¢Ëä±ÁÅ´Â§ß‰ºö',bg:'#d2691e',info:'„ÇÇ„Åø„ÅòÈ•ÖÈ†≠„ÇÑÁâ°Ë†£„ÅåÂêçÁâ©„ÄÇÂéüÁàÜ„Éâ„Éº„É†„ÇÇ‰∏ñÁïåÈÅ∫Áî£„ÄÇ',item:{name:'„ÇÇ„Åø„ÅòÈ•ÖÈ†≠',color:'#d2691e'},obstacle:{name:'Áâ°Ë†£',color:'#8b5e3c'},bgType:'sea'},
        {name:'Â±±Âè£Áúå',hanabi:'Èñ¢ÈñÄÊµ∑Â≥°Ëä±ÁÅ´Â§ß‰ºö',bg:'#aee',info:'„Åµ„Åê„ÇÑÁì¶„Åù„Å∞„ÅåÂêçÁâ©„ÄÇÁßãËä≥Ê¥û„ÇÇ‰∫∫Ê∞ó„ÄÇ',item:{name:'„Åµ„Åê',color:'#aee'},obstacle:{name:'Áì¶„Åù„Å∞',color:'#b5651d'},bgType:'sea'},
        {name:'Âæ≥Â≥∂Áúå',hanabi:'ÂêâÈáéÂ∑ù„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´Ëä±ÁÅ´Â§ß‰ºö',bg:'#aaff44',info:'„Åô„Å†„Å°„ÇÑÈòøÊ≥¢Ë∏ä„Çä„ÅåÊúâÂêç„ÄÇÈ≥¥ÈñÄ„ÅÆÊ∏¶ÊΩÆ„ÇÇ„ÄÇ',item:{name:'„Åô„Å†„Å°',color:'#aaff44'},obstacle:{name:'ÈòøÊ≥¢Ë∏ä„Çä',color:'#ffd700'},bgType:'mountain'},
        {name:'È¶ôÂ∑ùÁúå',hanabi:'„Åï„Å¨„ÅçÈ´òÊùæ„Åæ„Å§„ÇäËä±ÁÅ´Â§ß‰ºö',bg:'#fff',info:'„ÅÜ„Å©„Çì„ÇÑ„Ç™„É™„Éº„Éñ„ÅåÂêçÁâ©„ÄÇÂ∞èË±ÜÂ≥∂„ÇÇ‰∫∫Ê∞ó„ÄÇ',item:{name:'„ÅÜ„Å©„Çì',color:'#fff'},obstacle:{name:'„Ç™„É™„Éº„Éñ',color:'#228b22'},bgType:'sea'},
        {name:'ÊÑõÂ™õÁúå',hanabi:'ÊùæÂ±±Ê∏Ø„Åæ„Å§„Çä‰∏âÊ¥•ÊµúËä±ÁÅ´Â§ß‰ºö',bg:'#ffa500',info:'„Åø„Åã„Çì„ÇÑÈØõ„ÇÅ„Åó„ÅåÂêçÁâ©„ÄÇÈÅìÂæåÊ∏©Ê≥â„ÇÇ„ÄÇ',item:{name:'„Åø„Åã„Çì',color:'#ffa500'},obstacle:{name:'ÈØõ',color:'#ff8a65'},bgType:'sea'},
        {name:'È´òÁü•Áúå',hanabi:'È´òÁü•Â∏ÇÁ¥çÊ∂ºËä±ÁÅ´Â§ß‰ºö',bg:'#4e6c50',info:'„Ç´„ÉÑ„Ç™„ÅÆ„Åü„Åü„Åç„ÇÑ„ÇÜ„Åö„ÅåÂêçÁâ©„ÄÇÂùÇÊú¨ÈæçÈ¶¨„ÅÆÊïÖÈÉ∑„ÄÇ',item:{name:'„Ç´„ÉÑ„Ç™',color:'#4e6c50'},obstacle:{name:'„ÇÜ„Åö',color:'#aaff44'},bgType:'sea'},
        {name:'Á¶èÂ≤°Áúå',hanabi:'Á≠ëÂæåÂ∑ùËä±ÁÅ´Â§ß‰ºö',bg:'#ff6666',info:'ÊòéÂ§™Â≠ê„ÇÑÂçöÂ§ö„É©„Éº„É°„É≥„ÅåÂêçÁâ©„ÄÇÂ§™ÂÆ∞Â∫úÂ§©Ê∫ÄÂÆÆ„ÇÇ„ÄÇ',item:{name:'ÊòéÂ§™Â≠ê',color:'#ff6666'},obstacle:{name:'„É©„Éº„É°„É≥',color:'#ffeebb'},bgType:'city'},
        {name:'‰ΩêË≥ÄÁúå',hanabi:'‰πùÂ∑ûËä±ÁÅ´Â§ß‰ºö',bg:'#6b3e26',info:'‰ΩêË≥ÄÁâõ„ÇÑÊúâÁî∞ÁÑº„ÅåÂêçÁâ©„ÄÇÂêâÈáé„É∂ÈáåÈÅ∫Ë∑°„ÇÇ„ÄÇ',item:{name:'‰ΩêË≥ÄÁâõ',color:'#6b3e26'},obstacle:{name:'ÊúâÁî∞ÁÑº',color:'#fff'},bgType:'mountain'},
        {name:'Èï∑Â¥éÁúå',hanabi:'„Å™„Åå„Åï„Åç„Åø„Å™„Å®„Åæ„Å§„ÇäËä±ÁÅ´Â§ß‰ºö',bg:'#ffd700',info:'„Ç´„Çπ„ÉÜ„É©„ÇÑ„Å°„ÇÉ„Çì„ÅΩ„Çì„ÅåÂêçÁâ©„ÄÇ„Ç∞„É©„Éê„ÉºÂúí„ÇÇ„ÄÇ',item:{name:'„Ç´„Çπ„ÉÜ„É©',color:'#ffd700'},obstacle:{name:'„Å°„ÇÉ„Çì„ÅΩ„Çì',color:'#ffeebb'},bgType:'sea'},
        {name:'ÁÜäÊú¨Áúå',hanabi:'„ÇÑ„Å§„Åó„ÇçÂÖ®ÂõΩËä±ÁÅ´Á´∂ÊäÄÂ§ß‰ºö',bg:'#ff4444',info:'„Çπ„Ç§„Ç´„ÇÑÈ¶¨Âà∫„Åó„ÅåÂêçÁâ©„ÄÇÁÜäÊú¨Âüé„ÇÇÊúâÂêç„ÄÇ',item:{name:'„Çπ„Ç§„Ç´',color:'#ff4444'},obstacle:{name:'È¶¨Âà∫„Åó',color:'#b5651d'},bgType:'mountain'},
        {name:'Â§ßÂàÜÁúå',hanabi:'Â§ßÂàÜÂêàÂêåÊñ∞ËÅûÁ¥çÊ∂ºËä±ÁÅ´Â§ß‰ºö',bg:'#99ff99',info:'„Åã„Åº„Åô„ÇÑ„Å®„ÇäÂ§©„ÅåÂêçÁâ©„ÄÇÂà•Â∫úÊ∏©Ê≥â„ÇÇ„ÄÇ',item:{name:'„Åã„Åº„Åô',color:'#99ff99'},obstacle:{name:'„Å®„ÇäÂ§©',color:'#ffeebb'},bgType:'mountain'},
        {name:'ÂÆÆÂ¥éÁúå',hanabi:'„Åø„ÇÑ„Åñ„ÅçÁ¥çÊ∂ºËä±ÁÅ´Â§ß‰ºö',bg:'#ffbb44',info:'„Éû„É≥„Ç¥„Éº„ÇÑ„ÉÅ„Ç≠„É≥ÂçóËõÆ„ÅåÂêçÁâ©„ÄÇÈùíÂ≥∂„ÇÑÈ´òÂçÉÁ©ÇÂ≥°„ÇÇ„ÄÇ',item:{name:'„Éû„É≥„Ç¥„Éº',color:'#ffbb44'},obstacle:{name:'„ÉÅ„Ç≠„É≥ÂçóËõÆ',color:'#ffeebb'},bgType:'sea'},
        {name:'ÈπøÂÖêÂ≥∂Áúå',hanabi:'„Çµ„Éû„Éº„Éä„Ç§„ÉàÂ§ßËä±ÁÅ´Â§ß‰ºö',bg:'#222',info:'ÈªíË±ö„ÇÑ„Åï„Å§„ÅæÊèö„Åí„ÅåÂêçÁâ©„ÄÇÊ°úÂ≥∂„ÇÇÊúâÂêç„ÄÇ',item:{name:'ÈªíË±ö',color:'#222'},obstacle:{name:'„Åï„Å§„ÅæÊèö„Åí',color:'#ffeebb'},bgType:'mountain'},
        {name:'Ê≤ñÁ∏ÑÁúå',hanabi:'Êµ∑Ê¥ãÂçöÂÖ¨ÂúíËä±ÁÅ´Â§ß‰ºö',bg:'#ffcc44',info:'„Ç∑„Éº„Çµ„Éº„ÇÑ„Ç¥„Éº„É§„ÅåÂêçÁâ©„ÄÇÁæé„ÇâÊµ∑Ê∞¥ÊóèÈ§®„ÇÑÈ¶ñÈáåÂüé„ÇÇ„ÄÇ',item:{name:'„Ç∑„Éº„Çµ„Éº',color:'#ffcc44'},obstacle:{name:'„Ç¥„Éº„É§',color:'#228b22'},bgType:'sea'}
    ];
    // --- „Çª„É¨„ÇØ„ÉàÊóÖÁî®„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„ÇπÁîüÊàê ---
    function populatePrefectureSelect() {
        const select = document.getElementById('selectPrefecture');
        select.innerHTML = '';
        prefecturesData.forEach((pref, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = pref.name;
            select.appendChild(opt);
        });
    }
    // --- „Ç≤„Éº„É†„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜ ---
    let currentGameInstance = null;
    // --- FireworksJourneyGame„ÇØ„É©„ÇπÊú¨‰Ωì ---
    class FireworksJourneyGame {
        constructor(selectedPrefectures) {
            if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
                currentGameInstance._cancelAnimationFrame();
            }
            currentGameInstance = this;
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.resizeCanvas();
            this.prefectures = selectedPrefectures;
            this.currentPrefectureIndex = 0;
            this.sectionStartTime = Date.now();
            this.gameSpeed = 1.0;
            this.score = 0;
            this.life = 3;
            this.sectionTimeLimit = 60; // 1Áúå„ÅÇ„Åü„Çä1ÂàÜ
            this.player = {
                x: 100,
                y: this.canvas.height - 150,
                width: 40,
                height: 60,
                velocityY: 0,
                isJumping: false,
                groundY: this.canvas.height - 150,
                animFrame: 0,
                isHoldingJump: false,
                jumpStartTime: 0,
            };
            this.obstacles = [];
            this.items = [];
            this.background = { offset: 0 };
            this.stars = this.generateStars();
            this.isGameRunning = true;
            this._gameLoopId = null;
            this.setupControls();
            this.showCurrentPrefecture();
            this.showInstructions();
            this.playBGM();
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('jumpButton').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';
            this.updateUI();
            this.gameLoop();
        }
        _cancelAnimationFrame() {
            if (this._gameLoopId) {
                cancelAnimationFrame(this._gameLoopId);
                this._gameLoopId = null;
            }
        }
        resizeCanvas() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            if (this.player) {
                this.player.groundY = this.canvas.height - 150;
                if (!this.player.isJumping) {
                    this.player.y = this.player.groundY;
                }
            }
        }
        generateStars() {
            const stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * this.canvas.width * 3,
                    y: Math.random() * this.canvas.height * 0.6,
                    size: Math.random() * 2 + 1,
                    brightness: Math.random()
                });
            }
            return stars;
        }
        setupControls() {
            const jumpBtn = document.getElementById('jumpButton');
            // „Çø„ÉÉ„ÉÅ„Éª„Éû„Ç¶„Çπ‰∏°ÂØæÂøú
            jumpBtn.onmousedown = jumpBtn.ontouchstart = (e) => {
                e.preventDefault();
                this.startJump();
            };
            jumpBtn.onmouseup = jumpBtn.ontouchend = (e) => {
                e.preventDefault();
                this.endJump();
            };
            // „Ç≠„Éº„Éú„Éº„ÉâÂØæÂøú
            if (!this._keydownListener) {
                this._keydownListener = (e) => {
                    if (e.code === 'Space') this.startJump();
                };
                document.addEventListener('keydown', this._keydownListener);
            }
            if (!this._keyupListener) {
                this._keyupListener = (e) => {
                    if (e.code === 'Space') this.endJump();
                };
                document.addEventListener('keyup', this._keyupListener);
            }
            if (!this._resizeListener) {
                this._resizeListener = () => this.resizeCanvas();
                window.addEventListener('resize', this._resizeListener);
            }
        }
        startJump() {
            if (!this.player.isJumping && this.isGameRunning && this.player.y >= this.player.groundY) {
                this.player.isJumping = true;
                this.player.isHoldingJump = true;
                this.player.jumpStartTime = Date.now();
                this.player.velocityY = -15;
            } else if (this.player.isJumping) {
                this.player.isHoldingJump = true;
            }
        }
        endJump() {
            this.player.isHoldingJump = false;
        }
        update() {
            if (!this.isGameRunning) return;
            // „Éõ„Éº„É´„Éâ„Ç∏„É£„É≥„Éó
            if (this.player.isJumping) {
                const jumpDuration = (Date.now() - this.player.jumpStartTime) / 1000;
                if (this.player.isHoldingJump && jumpDuration < 3.0) {
                    this.player.velocityY = -10;
                } else {
                    this.player.isJumping = false;
                }
            }
            // ÈáçÂäõ
            this.player.velocityY += 0.8;
            this.player.y += this.player.velocityY;
            // Âú∞Èù¢
            if (this.player.y >= this.player.groundY) {
                this.player.y = this.player.groundY;
                this.player.velocityY = 0;
                this.player.isJumping = false;
                this.player.isHoldingJump = false;
            }
            // ËÉåÊôØ
            this.background.offset += this.gameSpeed * 2;
            this.stars.forEach(star => {
                star.x -= this.gameSpeed * 0.5;
                if (star.x < -10) {
                    star.x = this.canvas.width + Math.random() * 200;
                    star.y = Math.random() * this.canvas.height * 0.6;
                }
            });
            });
            // „Ç¢„Ç§„ÉÜ„É†
            if (Math.random() < 0.012) {
                const item = this.prefectures[this.currentPrefectureIndex].item;
                this.items.push({
                    x: this.canvas.width,
                    y: this.player.groundY - 30 - Math.random()*50,
                    width: 36,
                    height: 36,
                    color: item.color,
                    name: item.name,
                    sparkle: Math.random() < 0.13 // „Åü„Åæ„Å´„É¨„Ç¢„Ç≠„É©„Ç≠„É©
                });
            }
            this.items = this.items.filter(item => {
                item.x -= this.gameSpeed * 2;
                // „Ç¢„Ç§„ÉÜ„É†ÂèñÂæóÂà§ÂÆö
                if (
                    this.player.x < item.x + item.width &&
                    this.player.x + this.player.width > item.x &&
                    this.player.y < item.y + item.height &&
                    this.player.y + this.player.height > item.y
                ) {
                    this.score += item.sparkle ? 300 : 100;
                    this.launchFireworks();
                    this.showPop("+100", item.x, item.y, item.sparkle);
                    return false;
                }
                return item.x > -item.width;
            });
            // ÈöúÂÆ≥Áâ©
            if (Math.random() < 0.022) {
                const obs = this.prefectures[this.currentPrefectureIndex].obstacle;
                this.obstacles.push({
                    x: this.canvas.width,
                    y: this.player.groundY + 20,
                    width: 36,
                    height: 50,
                    color: obs.color,
                    name: obs.name,
                    shake: 0
                });
            }
            this.obstacles = this.obstacles.filter(obstacle => {
                obstacle.x -= this.gameSpeed * 3;
                // Ë°ùÁ™ÅÂà§ÂÆö
                const px = this.player.x, py = this.player.y, pw = this.player.width, ph = this.player.height;
                const ox = obstacle.x, oy = obstacle.y, ow = obstacle.width, oh = obstacle.height;
                const isColliding = (px < ox + ow && px + pw > ox && py < oy + oh && py + ph > oy);
                if (isColliding) {
                    // ‰∏ä„Å´‰πó„Å£„ÅüÂà§ÂÆö
                    const playerBottom = py + ph;
                    const obsTop = oy;
                    const isLandingOnTop =
                        (playerBottom > obsTop - 8 && playerBottom < obsTop + 16)
                        && this.player.velocityY > 0
                        && px + pw > ox + 5 && px < ox + ow - 5;
                    if (isLandingOnTop) {
                        // ÈöúÂÆ≥Áâ©„ÅÆ‰∏ä„Å´‰πó„Çã
                        this.player.y = obsTop - ph;
                        this.player.velocityY = 0;
                        this.player.isJumping = false;
                        this.player.isHoldingJump = false;
                        // ‰πó„Å£„Å¶„ÇãÈñì„ÅØÈöúÂÆ≥Áâ©„ÅåÂ∞ë„ÅóÊè∫„Çå„Çã
                        obstacle.shake = 6;
                        return true;
                    } else {
                        // ÂÅ¥Èù¢„Éª‰∏ã„Åã„ÇâÂΩì„Åü„Å£„ÅüÂ†¥Âêà„ÅÆ„Åø„É©„Ç§„ÉïÊ∏õÂ∞ë
                        this.life -= 1;
                        this.player.x = Math.max(50, this.player.x - 10);
                        obstacle.shake = 12;
                        if (this.life <= 0) this.gameOver();
                        return false;
                    }
                }
                if (obstacle.shake > 0) obstacle.shake--;
                return obstacle.x > -obstacle.width;
            });
            this.checkSectionTime();
            this.updateUI();
        }
        checkSectionTime() {
            const elapsed = (Date.now() - this.sectionStartTime) / 1000;
            if (elapsed >= this.sectionTimeLimit) {
                this.completePrefecture();
            }
        }
        completePrefecture() {
            this.currentPrefectureIndex++;
            this.sectionStartTime = Date.now();
            this.gameSpeed += 0.12;
            if (this.currentPrefectureIndex >= this.prefectures.length) {
                this.completeGame();
                return;
            }
            this.showCurrentPrefecture();
            this.launchFireworks(true);
            this.showPrefectureInfo();
            this.playBGM();
        }
        showCurrentPrefecture() {
            const prefectureElement = document.getElementById('currentPrefecture');
            const hanabiElement = document.getElementById('hanabiName');
            const data = this.prefectures[this.currentPrefectureIndex];
            prefectureElement.textContent = data.name;
            prefectureElement.style.opacity = '1';
            hanabiElement.textContent = data.hanabi ? `„Äå${data.hanabi}„Äç` : '';
            hanabiElement.style.opacity = '1';
            setTimeout(() => {
                prefectureElement.style.opacity = '0';
                hanabiElement.style.opacity = '0';
            }, 2500);
        }
        showPrefectureInfo() {
            const info = this.prefectures[this.currentPrefectureIndex].info;
            const infoDiv = document.getElementById('prefectureInfo');
            infoDiv.textContent = info;
            infoDiv.style.opacity = '1';
            setTimeout(() => {
                infoDiv.style.opacity = '0';
            }, 4000);
        }
        showInstructions() {
            document.getElementById('instructions').style.display = 'block';
        }
        launchFireworks(isBig) {
            const div = document.createElement('div');
            div.className = 'firework';
            div.style.left = (this.player.x + 50) + 'px';
            div.style.top = (this.player.y - 60) + 'px';
            div.style.width = isBig ? '80px' : '40px';
            div.style.height = isBig ? '80px' : '40px';
            div.style.background = 'radial-gradient(circle, #fff 0%, #f90 60%, transparent 100%)';
            div.style.borderRadius = '50%';
            div.style.opacity = '0.8';
            div.style.pointerEvents = 'none';
            div.style.zIndex = 400;
            document.body.appendChild(div);
            setTimeout(() => { div.remove(); }, 800);
        }
        showPop(text, x, y, sparkle) {
            const div = document.createElement('div');
            div.textContent = sparkle ? "‚ú®+300‚ú®" : text;
            div.style.position = "absolute";
            div.style.left = (x + 30) + "px";
            div.style.top = (y + 10) + "px";
            div.style.fontSize = "20px";
            div.style.fontWeight = "bold";
            div.style.color = sparkle ? "#e75480" : "#ffb347";
            div.style.textShadow = "0 2px 8px #fff, 0 1px 0 #fff";
            div.style.zIndex = 999;
            div.style.pointerEvents = "none";
            div.style.transition = "all 1s";
            div.style.opacity = "1";
            document.body.appendChild(div);
            setTimeout(() => {
                div.style.top = (y - 30) + "px";
                div.style.opacity = "0";
            }, 20);
            setTimeout(() => { div.remove(); }, 1100);
        }
        playBGM() {
            // „Çµ„Ç¶„É≥„Éâ„ÇíËøΩÂä†„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„Åì„Åì„Å´AudioÂÜçÁîüÂá¶ÁêÜ
        }
        updateUI() {
            document.getElementById('score').textContent = this.score;
            // „É©„Ç§„Éï„Çí„Éè„Éº„Éà„ÅßË°®Á§∫
            let heartStr = "";
            for (let i = 0; i < this.life; i++) heartStr += "‚ù§";
            document.getElementById('life').innerHTML = `<span class="heart">${heartStr}</span>`;
            document.getElementById('prefectureCount').textContent = `${this.currentPrefectureIndex+1}/${this.prefectures.length}`;
            const elapsed = Math.floor((Date.now() - this.sectionStartTime)/1000);
            const remain = Math.max(0, this.sectionTimeLimit - elapsed);
            document.getElementById('timer').textContent = `${Math.floor(remain/60)}:${('0'+(remain%60)).slice(-2)}`;
            document.getElementById('speed').textContent = `${this.gameSpeed.toFixed(1)}x`;
        }
        gameOver() {
            this.isGameRunning = false;
            this._cancelAnimationFrame();
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('gameOverText').textContent = "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº";
            document.getElementById('finalScore').textContent = `„Çπ„Ç≥„Ç¢: ${this.score}`;
            document.getElementById('jumpButton').style.display = 'none';
        }
        completeGame() {
            this.isGameRunning = false;
            this._cancelAnimationFrame();
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('gameOverText').textContent = "„ÇØ„É™„Ç¢ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜüéâ";
            document.getElementById('finalScore').textContent = `„ÇØ„É™„Ç¢ÔºÅ„Çπ„Ç≥„Ç¢: ${this.score}`;
            document.getElementById('jumpButton').style.display = 'none';
        }
        gameLoop() {
            if (!this.isGameRunning) return;
            this.update();
            this.draw();
            this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
        }
        draw() {
            // ËÉåÊôØ
            this.ctx.fillStyle = this.prefectures[this.currentPrefectureIndex].bg || '#a3d8f4';
            this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
            // Êòü
            this.ctx.save();
            this.ctx.globalAlpha = 0.7;
            this.stars.forEach(star => {
                this.ctx.beginPath();
                this.ctx.arc(star.x % this.canvas.width, star.y, star.size, 0, Math.PI*2);
                this.ctx.fillStyle = `rgba(255,255,255,${star.brightness})`;
                this.ctx.fill();
            });
            this.ctx.restore();
            // ÈöúÂÆ≥Áâ©
            this.obstacles.forEach(obs => {
                this.ctx.save();
                // ÂõõËßíÔºãÁôΩÁ∏ÅÔºãË≠¶Âëä„Ç¢„Ç§„Ç≥„É≥
                let shakeX = obs.shake ? (Math.random()-0.5)*obs.shake : 0;
                let shakeY = obs.shake ? (Math.random()-0.5)*obs.shake : 0;
                this.ctx.fillStyle = obs.color;
                this.ctx.strokeStyle = "#fff";
                this.ctx.lineWidth = 3;
                this.ctx.fillRect(obs.x+shakeX, obs.y+shakeY, obs.width, obs.height);
                this.ctx.strokeRect(obs.x+shakeX, obs.y+shakeY, obs.width, obs.height);
                // „Ç¢„Ç§„Ç≥„É≥
                this.ctx.font = 'bold 18px "M PLUS Rounded 1c", Arial';
                this.ctx.textAlign = "center";
                this.ctx.fillText("‚ö†Ô∏è", obs.x+obs.width/2+shakeX, obs.y+obs.height/2+6+shakeY);
                // ÂêçÁß∞
                this.ctx.font = 'bold 12px "M PLUS Rounded 1c", Arial';
                this.ctx.fillStyle = '#775533';
                this.ctx.fillText(obs.name, obs.x+obs.width/2+shakeX, obs.y-6+shakeY);
                this.ctx.restore();
            });
            // „Ç¢„Ç§„ÉÜ„É†
            this.items.forEach(item => {
                this.ctx.save();
                // ‰∏∏Ôºã„Éë„Çπ„ÉÜ„É´Â§ñÊû†Ôºã„Ç≠„É©„Ç≠„É©
                this.ctx.beginPath();
                this.ctx.arc(item.x+item.width/2, item.y+item.height/2, item.width/2, 0, Math.PI*2);
                this.ctx.fillStyle = item.color;
                this.ctx.shadowColor = "#fffbe8";
                this.ctx.shadowBlur = 12;
                this.ctx.fill();
                // Â§ñÊû†
                this.ctx.lineWidth = 3;
                this.ctx.strokeStyle = "#fffbe8";
                this.ctx.stroke();
                // „Ç≠„É©„Ç≠„É©
                if (item.sparkle) {
                    this.ctx.globalAlpha = 0.7;
                    this.ctx.beginPath();
                    this.ctx.arc(item.x+item.width/2, item.y+item.height/2, item.width/4, 0, Math.PI*2);
                    this.ctx.fillStyle = "#fff";
                    this.ctx.fill();
                    this.ctx.globalAlpha = 1.0;
                }
                // „Ç¢„Ç§„ÉÜ„É†Âêç
                this.ctx.font = 'bold 13px "M PLUS Rounded 1c", Arial';
                this.ctx.fillStyle = '#e75480';
                this.ctx.textAlign = "center";
                this.ctx.fillText(item.name, item.x+item.width/2, item.y+item.height+16);
                this.ctx.restore();
            });
            // „Éó„É¨„Ç§„É§„Éº„Ç≠„É£„É©„ÇØ„Çø„ÉºÔºàÂèØÊÑõ„ÅÑ„ÇÜ„Çã„Ç≠„É£„É©Ôºâ
            this.ctx.save();
            const px = this.player.x, py = this.player.y;
            // ‰Ωì
            this.ctx.beginPath();
            this.ctx.ellipse(px+20, py+50, 18, 24, 0, 0, Math.PI*2);
            this.ctx.fillStyle = "#ffe6fa";
            this.ctx.shadowColor = "#e0f7fa";
            this.ctx.shadowBlur = 8;
            this.ctx.fill();
            // È°î
            this.ctx.beginPath();
            this.ctx.arc(px+20, py+26, 20, 0, Math.PI*2);
            this.ctx.fillStyle = "#fffbe8";
            this.ctx.shadowColor = "#ffb6d5";
            this.ctx.shadowBlur = 12;
            this.ctx.fill();
            // „Åª„Å£„Å∫
            this.ctx.beginPath();
            this.ctx.arc(px+12, py+34, 4, 0, Math.PI*2);
            this.ctx.arc(px+28, py+34, 4, 0, Math.PI*2);
            this.ctx.fillStyle = "#ffb6d5";
            this.ctx.globalAlpha = 0.5;
            this.ctx.fill();
            this.ctx.globalAlpha = 1.0;
            // ÁõÆ
            this.ctx.beginPath();
            this.ctx.arc(px+14, py+26, 3, 0, Math.PI*2);
            this.ctx.arc(px+26, py+26, 3, 0, Math.PI*2);
            this.ctx.fillStyle = "#a14f7a";
            this.ctx.fill();
            // Âè£
            this.ctx.beginPath();
            this.ctx.arc(px+20, py+32, 5, Math.PI*0.15, Math.PI*0.85);
            this.ctx.lineWidth = 2;
            this.ctx.strokeStyle = "#e75480";
            this.ctx.stroke();
            // Êâã
            this.ctx.beginPath();
            this.ctx.arc(px+6, py+50, 5, 0, Math.PI*2);
            this.ctx.arc(px+34, py+50, 5, 0, Math.PI*2);
            this.ctx.fillStyle = "#ffe6fa";
            this.ctx.fill();
            // ÂΩ±Ôºà„Ç∏„É£„É≥„Éó‰∏≠„ÅØ‰∏ã„Å´ÂΩ±Ôºâ
            if (this.player.y < this.player.groundY) {
                this.ctx.globalAlpha = 0.3;
                this.ctx.beginPath();
                this.ctx.ellipse(px+20, this.player.groundY+60, 18, 7, 0, 0, Math.PI*2);
                this.ctx.fillStyle = "#a3d8f4";
                this.ctx.fill();
                this.ctx.globalAlpha = 1.0;
            }
            this.ctx.restore();
        }
    }
    // --- „É¢„Éº„ÉâÈÅ∏Êäû„Ç§„Éô„É≥„ÉàËøΩÂä† ---
    function startGameWithPrefectures(prefList) {
        if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
            currentGameInstance._cancelAnimationFrame();
        }
        document.getElementById('modeSelect').style.display = 'none';
        document.getElementById('ui').style.display = 'flex';
        document.getElementById('jumpButton').style.display = 'block';
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('instructions').style.display = 'block';
        new FireworksJourneyGame(prefList);
    }
    document.getElementById('fullModeBtn').onclick = function() {
        startGameWithPrefectures([...prefecturesData]);
    };
    document.getElementById('shortModeBtn').onclick = function() {
        const shuffled = [...prefecturesData].sort(() => Math.random() - 0.5);
        startGameWithPrefectures(shuffled.slice(0, 5));
    };
    document.getElementById('selectModeBtn').onclick = function() {
        const select = document.getElementById('selectPrefecture');
        const selected = Array.from(select.selectedOptions).map(opt => prefecturesData[opt.value]);
        if (selected.length === 0) {
            alert('1„Å§‰ª•‰∏ä„ÅÆÁúå„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        startGameWithPrefectures(selected);
    };
    document.getElementById('retryBtn').onclick = function() {
        if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
            currentGameInstance._cancelAnimationFrame();
        }
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('ui').style.display = 'none';
        document.getElementById('jumpButton').style.display = 'none';
        document.getElementById('instructions').style.display = 'block';
        document.getElementById('modeSelect').style.display = 'block';
        populatePrefectureSelect();
    };
    window.addEventListener('DOMContentLoaded', populatePrefectureSelect);
    </script>
</body>
</html>
