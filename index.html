<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花火師の旅 - 47都道府県</title>
    <style>
        html, body { margin: 0; padding: 0; background: #001122; font-family: 'Arial', sans-serif; overflow: hidden; user-select: none; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #gameCanvas { position: absolute; top: 0; left: 0; background: #001122; }
        #ui, #modeSelect { position: absolute; top: 20px; left: 20px; color: white; z-index: 100; font-size: 18px; }
        #currentPrefecture { position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%); color: #ffff88; font-size: 48px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); z-index: 200; opacity: 0; transition: opacity 0.5s; text-align: center; }
        #hanabiName { position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); color: #ffb347; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 6px #000; z-index: 210; opacity: 0; transition: opacity 0.5s; text-align: center; }
        #instructions { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); color: white; text-align: center; z-index: 100; }
        .firework { position: absolute; pointer-events: none; z-index: 150; }
        #jumpButton { position: absolute; bottom: 0; left: 0; width: 100vw; height: 70px; background: rgba(40,40,80,0.7); color: #fff; font-size: 28px; text-align: center; line-height: 70px; z-index: 300; user-select: none; border: none; outline: none; }
        #jumpButton:active { background: rgba(80,80,160,0.7); }
        #gameOver { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 40px; font-weight: bold; text-shadow: 2px 2px 6px #000; z-index: 500; display: none; text-align: center; }
        #prefectureInfo { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 20px; background: rgba(0,0,0,0.7); border-radius: 12px; padding: 16px 24px; z-index: 220; opacity: 0; transition: opacity 0.5s; max-width: 90vw; text-align: center; }
        #modeSelect { background: rgba(0,0,0,0.85); padding: 30px 40px; border-radius: 18px; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 900; display: block; text-align: center; }
        #modeSelect button { display: block; margin: 18px auto; font-size: 22px; padding: 12px 36px; border-radius: 8px; border: none; background: #2c5530; color: #fff; cursor: pointer; transition: background 0.2s; }
        #modeSelect button:hover { background: #3a7a48; }
        #modeSelect label { font-size: 18px; }
        #modeSelect select { font-size: 18px; margin: 0 8px; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui" style="display:none;">
            <div>都道府県: <span id="prefectureCount">1/47</span></div>
            <div>スコア: <span id="score">0</span></div>
            <div>ライフ: <span id="life">3</span></div>
            <div>時間: <span id="timer">0:00</span></div>
            <div>速度: <span id="speed">1.0x</span></div>
        </div>
        <div id="currentPrefecture"></div>
        <div id="hanabiName"></div>
        <div id="prefectureInfo"></div>
        <div id="instructions" style="display:none;">
            <div>画面下のボタンでジャンプ！</div>
            <div>ご当地アイテムを集めてスコアUP！</div>
        </div>
        <button id="jumpButton" style="display:none;">ジャンプ！</button>
        <div id="gameOver">
            ゲームオーバー<br>
            <span id="finalScore"></span><br>
            <button id="retryBtn" style="margin-top:20px;font-size:20px;">もう一度遊ぶ</button>
        </div>
        <div id="modeSelect">
            <h2>モード選択</h2>
            <button id="fullModeBtn">全国制覇（47都道府県）</button>
            <button id="shortModeBtn">ショート旅（5県ランダム）</button>
            <label>セレクト旅（県を選ぶ）</label>
            <select id="selectPrefecture" multiple size="7" style="width:180px;vertical-align:middle;"></select>
            <button id="selectModeBtn">この県でスタート</button>
        </div>
    </div>
    <script>
    // --- 全47都道府県データ ---
    const prefecturesData = [
        // ...（元の都道府県データをここに貼り付けてください）...
    ];

    // --- セレクト旅用セレクトボックス生成 ---
    function populatePrefectureSelect() {
        const select = document.getElementById('selectPrefecture');
        select.innerHTML = '';
        prefecturesData.forEach((pref, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = pref.name;
            select.appendChild(opt);
        });
    }

    // --- ゲームインスタンス管理 ---
    let currentGameInstance = null;

    // --- FireworksJourneyGameクラス本体 ---
    class FireworksJourneyGame {
        constructor(selectedPrefectures) {
            // 既存ゲームループ停止
            if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
                currentGameInstance._cancelAnimationFrame();
            }
            currentGameInstance = this;

            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.resizeCanvas();

            this.prefectures = selectedPrefectures;
            this.currentPrefectureIndex = 0;
            this.sectionStartTime = Date.now();
            this.gameSpeed = 1.0;
            this.score = 0;
            this.life = 3;
            this.sectionTimeLimit = 60; // 1県あたり1分

            this.player = {
                x: 100,
                y: this.canvas.height - 150,
                width: 40,
                height: 60,
                velocityY: 0,
                isJumping: false,
                groundY: this.canvas.height - 150,
                animFrame: 0
            };

            this.obstacles = [];
            this.items = [];
            this.background = { offset: 0 };
            this.stars = this.generateStars();
            this.isGameRunning = true;

            this._gameLoopId = null;

            this.setupControls();
            this.showCurrentPrefecture();
            this.showInstructions();
            this.playBGM();

            // UI初期化
            document.getElementById('ui').style.display = 'block';
            document.getElementById('jumpButton').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';

            this.updateUI();
            this.gameLoop();
        }

        _cancelAnimationFrame() {
            if (this._gameLoopId) {
                cancelAnimationFrame(this._gameLoopId);
                this._gameLoopId = null;
            }
        }

        resizeCanvas() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            if (this.player) {
                this.player.groundY = this.canvas.height - 150;
                if (!this.player.isJumping) {
                    this.player.y = this.player.groundY;
                }
            }
        }

        generateStars() {
            const stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * this.canvas.width * 3,
                    y: Math.random() * this.canvas.height * 0.6,
                    size: Math.random() * 2 + 1,
                    brightness: Math.random()
                });
            }
            return stars;
        }

        setupControls() {
            // ジャンプ操作
            const jump = () => {
                if (!this.player.isJumping && this.isGameRunning) {
                    this.player.velocityY = -15;
                    this.player.isJumping = true;
                }
            };
            // 既存イベントを一度removeしてからadd
            const jumpBtn = document.getElementById('jumpButton');
            jumpBtn.onclick = jump;
            jumpBtn.ontouchstart = (e) => { e.preventDefault(); jump(); };
            // キーボード
            if (!this._keydownListener) {
                this._keydownListener = (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        jump();
                    }
                };
                document.addEventListener('keydown', this._keydownListener);
            }
            // リサイズ
            if (!this._resizeListener) {
                this._resizeListener = () => this.resizeCanvas();
                window.addEventListener('resize', this._resizeListener);
            }
        }

        update() {
            if (!this.isGameRunning) return;

            // プレイヤー物理
            this.player.velocityY += 0.8;
            this.player.y += this.player.velocityY;
            if (this.player.y >= this.player.groundY) {
                this.player.y = this.player.groundY;
                this.player.velocityY = 0;
                this.player.isJumping = false;
            }

            // 背景スクロール
            this.background.offset += this.gameSpeed * 2;

            // 星スクロール
            this.stars.forEach(star => {
                star.x -= this.gameSpeed * 0.5;
                if (star.x < -10) {
                    star.x = this.canvas.width + Math.random() * 200;
                    star.y = Math.random() * this.canvas.height * 0.6;
                }
            });

            // アイテム生成
            if (Math.random() < 0.012) {
                const item = this.prefectures[this.currentPrefectureIndex].item;
                this.items.push({
                    x: this.canvas.width,
                    y: this.player.groundY - 30 - Math.random()*50,
                    width: 30,
                    height: 30,
                    color: item.color,
                    name: item.name
                });
            }
            // アイテム移動・取得判定
            this.items = this.items.filter(item => {
                item.x -= this.gameSpeed * 2;
                if (
                    this.player.x < item.x + item.width &&
                    this.player.x + this.player.width > item.x &&
                    this.player.y < item.y + item.height &&
                    this.player.y + this.player.height > item.y
                ) {
                    this.score += 100;
                    this.launchFireworks();
                    return false;
                }
                return item.x > -item.width;
            });

            // 障害物生成
            if (Math.random() < 0.022) {
                const obs = this.prefectures[this.currentPrefectureIndex].obstacle;
                this.obstacles.push({
                    x: this.canvas.width,
                    y: this.player.groundY + 20,
                    width: 30,
                    height: 50,
                    color: obs.color,
                    name: obs.name
                });
            }
            // 障害物移動・当たり判定
            this.obstacles = this.obstacles.filter(obstacle => {
                obstacle.x -= this.gameSpeed * 3;
                if (
                    this.player.x < obstacle.x + obstacle.width &&
                    this.player.x + this.player.width > obstacle.x &&
                    this.player.y < obstacle.y + obstacle.height &&
                    this.player.y + this.player.height > obstacle.y
                ) {
                    this.life -= 1;
                    this.player.x = Math.max(50, this.player.x - 10);
                    if (this.life <= 0) this.gameOver();
                    return false;
                }
                return obstacle.x > -obstacle.width;
            });

            this.checkSectionTime();
            this.updateUI();
        }

        checkSectionTime() {
            const elapsed = (Date.now() - this.sectionStartTime) / 1000;
            if (elapsed >= this.sectionTimeLimit) {
                this.completePrefecture();
            }
        }

        completePrefecture() {
            this.currentPrefectureIndex++;
            this.sectionStartTime = Date.now();
            this.gameSpeed += 0.12;
            if (this.currentPrefectureIndex >= this.prefectures.length) {
                this.completeGame();
                return;
            }
            this.showCurrentPrefecture();
            this.launchFireworks(true); // ご当地花火
            this.showPrefectureInfo();
            this.playBGM();
        }

        showCurrentPrefecture() {
            const prefectureElement = document.getElementById('currentPrefecture');
            const hanabiElement = document.getElementById('hanabiName');
            const data = this.prefectures[this.currentPrefectureIndex];
            prefectureElement.textContent = data.name;
            prefectureElement.style.opacity = '1';
            hanabiElement.textContent = data.hanabi ? `「${data.hanabi}」` : '';
            hanabiElement.style.opacity = '1';
            setTimeout(() => {
                prefectureElement.style.opacity = '0';
                hanabiElement.style.opacity = '0';
            }, 2500);
        }

        showPrefectureInfo() {
            const info = this.prefectures[this.currentPrefectureIndex].info;
            const infoDiv = document.getElementById('prefectureInfo');
            infoDiv.textContent = info;
            infoDiv.style.opacity = '1';
            setTimeout(() => {
                infoDiv.style.opacity = '0';
            }, 4000);
        }

        showInstructions() {
            document.getElementById('instructions').style.display = 'block';
        }

        launchFireworks(isBig) {
            // 簡易エフェクト
            const div = document.createElement('div');
            div.className = 'firework';
            div.style.left = (this.player.x + 50) + 'px';
            div.style.top = (this.player.y - 60) + 'px';
            div.style.width = isBig ? '80px' : '40px';
            div.style.height = isBig ? '80px' : '40px';
            div.style.background = 'radial-gradient(circle, #fff 0%, #f90 60%, transparent 100%)';
            div.style.borderRadius = '50%';
            div.style.opacity = '0.8';
            div.style.pointerEvents = 'none';
            div.style.zIndex = 400;
            document.body.appendChild(div);
            setTimeout(() => { div.remove(); }, 800);
        }

        playBGM() {
            // BGM未実装。必要ならここでAudio再生
        }

        updateUI() {
            document.getElementById('score').textContent = this.score;
            document.getElementById('life').textContent = this.life;
            document.getElementById('prefectureCount').textContent = `${this.currentPrefectureIndex+1}/${this.prefectures.length}`;
            // タイマー表示
            const elapsed = Math.floor((Date.now() - this.sectionStartTime)/1000);
            const remain = Math.max(0, this.sectionTimeLimit - elapsed);
            document.getElementById('timer').textContent = `${Math.floor(remain/60)}:${('0'+(remain%60)).slice(-2)}`;
            document.getElementById('speed').textContent = `${this.gameSpeed.toFixed(1)}x`;
        }

        gameOver() {
            this.isGameRunning = false;
            this._cancelAnimationFrame();
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalScore').textContent = `スコア: ${this.score}`;
            document.getElementById('jumpButton').style.display = 'none';
        }

        completeGame() {
            this.isGameRunning = false;
            this._cancelAnimationFrame();
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalScore').textContent = `クリア！スコア: ${this.score}`;
            document.getElementById('jumpButton').style.display = 'none';
        }

        gameLoop() {
            if (!this.isGameRunning) return;
            this.update();
            this.draw();
            this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
        }

        draw() {
            // 背景
            this.ctx.fillStyle = this.prefectures[this.currentPrefectureIndex].bg || '#001122';
            this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);

            // 星
            this.ctx.save();
            this.ctx.globalAlpha = 0.7;
            this.stars.forEach(star => {
                this.ctx.beginPath();
                this.ctx.arc(star.x % this.canvas.width, star.y, star.size, 0, Math.PI*2);
                this.ctx.fillStyle = `rgba(255,255,255,${star.brightness})`;
                this.ctx.fill();
            });
            this.ctx.restore();

            // プレイヤー
            this.ctx.save();
            this.ctx.fillStyle = '#fff';
            this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);
            this.ctx.restore();

            // アイテム
            this.items.forEach(item => {
                this.ctx.save();
                this.ctx.fillStyle = item.color;
                this.ctx.fillRect(item.x, item.y, item.width, item.height);
                this.ctx.font = '12px Arial';
                this.ctx.fillStyle = '#222';
                this.ctx.fillText(item.name, item.x, item.y+item.height+12);
                this.ctx.restore();
            });

            // 障害物
            this.obstacles.forEach(obs => {
                this.ctx.save();
                this.ctx.fillStyle = obs.color;
                this.ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                this.ctx.font = '12px Arial';
                this.ctx.fillStyle = '#fff';
                this.ctx.fillText(obs.name, obs.x, obs.y-4);
                this.ctx.restore();
            });
        }
    }

    // --- モード選択イベント追加 ---
    function startGameWithPrefectures(prefList) {
        // 既存ゲーム停止
        if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
            currentGameInstance._cancelAnimationFrame();
        }
        document.getElementById('modeSelect').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        document.getElementById('jumpButton').style.display = 'block';
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('instructions').style.display = 'block';
        new FireworksJourneyGame(prefList);
    }

    document.getElementById('fullModeBtn').onclick = function() {
        startGameWithPrefectures([...prefecturesData]);
    };

    document.getElementById('shortModeBtn').onclick = function() {
        // 5県ランダム
        const shuffled = [...prefecturesData].sort(() => Math.random() - 0.5);
        startGameWithPrefectures(shuffled.slice(0, 5));
    };

    document.getElementById('selectModeBtn').onclick = function() {
        const select = document.getElementById('selectPrefecture');
        const selected = Array.from(select.selectedOptions).map(opt => prefecturesData[opt.value]);
        if (selected.length === 0) {
            alert('1つ以上の県を選択してください');
            return;
        }
        startGameWithPrefectures(selected);
    };

    // --- リトライボタンで最初に戻る ---
    document.getElementById('retryBtn').onclick = function() {
        if (currentGameInstance && currentGameInstance._cancelAnimationFrame) {
            currentGameInstance._cancelAnimationFrame();
        }
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('ui').style.display = 'none';
        document.getElementById('jumpButton').style.display = 'none';
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('modeSelect').style.display = 'block';
        populatePrefectureSelect();
    };

    // --- ページロード時にセレクトボックス生成 ---
    window.addEventListener('DOMContentLoaded', populatePrefectureSelect);

    </script>
</body>
</html>
